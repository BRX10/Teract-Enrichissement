<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teract • Générateur IA</title>
  <link rel="stylesheet" href="styles.css" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    function App() {
      const [file, setFile] = React.useState(null);
      const [preview, setPreview] = React.useState([]);
      const [columns, setColumns] = React.useState([]);
      const [loading, setLoading] = React.useState(false);
      const [downloadUrl, setDownloadUrl] = React.useState("");

      const handleUpload = (e) => {
        const f = e.target.files[0];
        setFile(f);
        setDownloadUrl("");
        if (f) {
          const data = new FormData();
          data.append("file", f);
          fetch("/preview", { method: "POST", body: data })
            .then(res => res.json())
            .then(json => {
              setPreview(json.rows);
              setColumns(json.columns);
            })
            .catch(err => alert(err));
        }
      };

      const generate = () => {
        if (!file) return;
        setLoading(true);
        const data = new FormData();
        data.append("file", file);
        fetch("/generate", { method: "POST", body: data })
          .then(res => {
            if (!res.ok) throw new Error("Erreur de génération");
            return res.blob();
          })
          .then(blob => {
            setDownloadUrl(URL.createObjectURL(blob));
            setLoading(false);
          })
          .catch(err => { alert(err); setLoading(false); });
      };

      return (
        <div className="container">
          <h1>Teract • Générateur Marketing IA</h1>
          <input type="file" onChange={handleUpload} />
          {preview.length > 0 && (
            <table>
              <thead>
                <tr>{columns.map(c => <th key={c}>{c}</th>)}</tr>
              </thead>
              <tbody>
                {preview.map((row, i) => (
                  <tr key={i}>{columns.map(c => <td key={c}>{row[c]}</td>)}</tr>
                ))}
              </tbody>
            </table>
          )}
          <button onClick={generate} disabled={!file || loading}>
            {loading ? "Traitement…" : "Lancer la génération"}
          </button>
          {downloadUrl && (
            <p><a href={downloadUrl} download="catalogue_enrichi.xlsx">Télécharger le fichier</a></p>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
